<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>AST.html</title>
<meta http-equiv="Content-Type" content="application/xhtml+xml;charset=utf-8"/>
<link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"  />
<link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css"  /><meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'><style> body { box-sizing: border-box; max-width: 740px; width: 100%; margin: 40px auto; padding: 0 10px; } </style><script id='MathJax-script' async src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script><script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script><script>document.addEventListener('DOMContentLoaded', () => { document.body.classList.add('markdown-body'); document.querySelectorAll('pre[lang] > code').forEach((code) => { code.classList.add(code.parentElement.lang); }); document.querySelectorAll('pre > code').forEach((code) => { hljs.highlightBlock(code); }); });</script>
</head>

<body>

<h1 id="cybermonday-ir-ast-and-transformation">Cybermonday IR AST and Transformation</h1>
<p>To fully capture the information available from the parse result from Flexmark, the first pass tree-transformation from Flexmark is into an intermediate representation (IR). Some nodes (say like <code>BulletListItem</code> and <code>OrderedListItem</code>) would normally render to the same HTML tag (<code>:li</code>), which would prevent the user from disambiguating between them and prevent special case post-processing. Some nodes, given below, are unambiguous, so their corresponding HTML tag is fed through, and as such, these IR AST nodes are completely valid hiccup. However, we want to be able to still provide the ability to transform these as need be.</p>
<p>So, the AST nodes are broken into two categories:</p>
<h2 id="html-nodes">HTML nodes</h2>
<p>These are the standard, unambiguous tags. Paragraph (<code>:p</code>), TableRow (<code>:tr</code>), etc. These are standard HTML hiccup and are not namespaced keywords.</p>
<h2 id="ir-nodes">IR Nodes</h2>
<p>The rest of the AST is formed from namespaced keywords and a corresponding data map and body. Cybermonday will provide default processing, but the corresponding data layouts for each node are enumerated below to allow for custom processing into final html hiccup.</p>
<h3 id="bullet-list-item">Bullet List Item</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/bullet-list-item</span> <span class="st">&quot;Item&quot;</span>]</span></code></pre></div>
<h3 id="ordered-list-item">Ordered List Item</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/ordered-list-item</span> <span class="st">&quot;Item&quot;</span>]</span></code></pre></div>
<h3 id="hard-line-break">Hard Line Break</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/hard-line-break</span>]</span></code></pre></div>
<h3 id="soft-line-break">Soft Line Break</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/soft-line-break</span>]</span></code></pre></div>
<h3 id="heading">Heading</h3>
<p><code>:id</code> (potentially <code>nil</code>) is a string of the heading id. <code>:level</code> will take integer values 1-6.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/heading</span> {<span class="at">:level</span> <span class="dv">1</span> <span class="at">:id</span> <span class="st">&quot;my-heading&quot;</span>} <span class="st">&quot;Heading&quot;</span>]</span></code></pre></div>
<h3 id="fenced-code-block">Fenced Code Block</h3>
<p><code>:language</code> (potentially <code>nil</code>) is a string of the tagged language.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/fenced-code-block</span> {<span class="at">:language</span> <span class="st">&quot;julia&quot;</span>} <span class="st">&quot;code&quot;</span>]</span></code></pre></div>
<h3 id="indented-code-block">Indented Code Block</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/indented-code-block</span> <span class="st">&quot;code&quot;</span>]</span></code></pre></div>
<h3 id="table-separator">Table Separator</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/table-separator</span>]</span></code></pre></div>
<h3 id="table-cell">Table Cell</h3>
<p><code>:header?</code> is a boolean indicating whether this cell is a header. <code>:alignment</code> (potentially <code>nil</code>) will indicate cell alignment (“left”, “right”, or “center”)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/table-cell</span> {<span class="at">:header</span>? <span class="va">true</span> <span class="at">:alignment</span> <span class="st">&quot;center&quot;</span>}]</span></code></pre></div>
<h3 id="link">Link</h3>
<p><code>:href</code> specifies the link url <code>:title</code> (potentially <code>nil</code>) contains the optional link title</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/link</span> {<span class="at">:href</span> <span class="st">&quot;https://example.com&quot;</span> <span class="at">:title</span> <span class="st">&quot;A neat website&quot;</span>} <span class="st">&quot;Click me&quot;</span>]</span></code></pre></div>
<h3 id="reference">Reference</h3>
<p><code>:title</code> (potentially <code>nil</code>) contains the optional link title <code>:label</code> contains the reference label <code>:href</code> contains the reference url</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/reference</span> {<span class="at">:title</span> <span class="st">&quot;Title&quot;</span>, <span class="at">:label</span> <span class="st">&quot;1&quot;</span>, <span class="at">:href</span> <span class="st">&quot;/url&quot;</span>}]</span></code></pre></div>
<h3 id="link-reference">Link Reference</h3>
<p><code>:reference</code> (potentially <code>nil</code>) contains the <code>:cybermonday.ir/reference</code> AST node of the referenced link.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/link-ref</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a> {<span class="at">:reference</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:cybermonday.ir/reference</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:title</span> <span class="st">&quot;Foo&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">:label</span> <span class="st">&quot;1&quot;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">:href</span> <span class="st">&quot;#baz&quot;</span>}]}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;Bar&quot;</span>]</span></code></pre></div>
<h3 id="image">Image</h3>
<p><code>:src</code> contains the image url <code>:alt</code> contains the image alt text <code>:title</code> (potentially <code>nil</code>) contains the optional link title</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/image</span> {<span class="at">:src</span> <span class="st">&quot;cat.png&quot;</span> <span class="at">:alt</span> <span class="st">&quot;Witty alt-text&quot;</span> <span class="at">:title</span> <span class="st">&quot;More info&quot;</span>}]</span></code></pre></div>
<h3 id="auto-link">Auto Link</h3>
<p><code>:href</code> contains the link url</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/autolink</span> {<span class="at">:href</span> <span class="st">&quot;www.foo.bar&quot;</span>}]</span></code></pre></div>
<h3 id="mail-link">Mail Link</h3>
<p><code>:address</code> contains the email address</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/mail-link</span> {<span class="at">:address</span> <span class="st">&quot;you@example.com&quot;</span>}]</span></code></pre></div>
<h3 id="html-comments">HTML Comments</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/html-comment</span> <span class="st">&quot;&lt;!--I&#39;m a comment!--&gt;&quot;</span>]</span></code></pre></div>
<h2 id="non-commonmark-extensions">Non Commonmark Extensions</h2>
<h3 id="inline-math">Inline Math</h3>
<p>From the GitLab extension. Inline math is delimited with <code>$\</code>y=mx+b`$`. As one might want to choose the rendering backend, unlike GitLab - the default translation to HTML will be as is as text.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/inline-math</span> <span class="st">&quot;y=mx+b&quot;</span>]</span></code></pre></div>
<h3 id="attributes">Attributes</h3>
<p>Following the details from the <a href="https://github.com/vsch/flexmark-java/wiki/Attributes-Extension">flexmark spec</a>. Cybermonday differs from the default configuration as <code>ASSIGN_TEXT_ATTRIBUTES</code> is set to false. This implies that inline attributes will always configure the parent element. This is due to the fact that the way the Flexmark AST is built for the extended behavior, merging attributes into leaves at the same level makes the transformation much more difficult. If a need for this feature comes up, it might be worth looking into, but the primary use case of heading <code>:id</code>s is unaffected.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/attributes</span> {<span class="at">:key</span> <span class="st">&quot;value&quot;</span>}]</span></code></pre></div>
<h3 id="definitions">Definitions</h3>
<p>From the <a href="https://michelf.ca/projects/php-markdown/extra/#def-list">PHP Markdown Extra Definition List</a>.</p>
<h4 id="definition-list-term-and-items">Definition List, Term, and Items</h4>
<p>The definition list contains the term and item children nodes. The term and item bodies can of course contain additional hiccup.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a> [<span class="at">:cybermonday.ir/definition-list</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:cybermonday.ir/definition-term</span> <span class="st">&quot;Foo&quot;</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:cybermonday.ir/definition-item</span> [<span class="at">:p</span> <span class="st">&quot;Bar&quot;</span>]]]</span></code></pre></div>
<h3 id="footnotes">Footnotes</h3>
<p>Enables footnotes in the common format. Details <a href="https://github.com/vsch/flexmark-java/wiki/Footnotes-Extension">here</a></p>
<h4 id="footnote">Footnote</h4>
<p><code>:id</code> contains the footnote id</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/footnote</span> {<span class="at">:id</span> <span class="st">&quot;1&quot;</span>}]</span></code></pre></div>
<h4 id="footnote-block">Footnote Block</h4>
<p><code>:id</code> contains the footnote id <code>:content</code> contains the footnote content</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>[<span class="at">:cybermonday.ir/footnote-block</span> {<span class="at">:id</span> <span class="st">&quot;1&quot;</span> <span class="at">:content</span> <span class="st">&quot;I&#39;m a footnote&quot;</span>}]</span></code></pre></div>
<h1 id="lowering-extension-examples">Lowering Extension Examples</h1>
<p>Here are a few examples of overrides for the default lowering functions to extend functionality</p>
<h2 id="katex-math-rendering">KaTeX math rendering</h2>
<p>Using the Auto-render extension for KaTeX, replacing inline math with the proper delimiters enables math rendering</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> my-library</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>   [cybermonday.ir <span class="at">:as</span> ir]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>   [cybermonday.lowering <span class="at">:refer</span> [lower]]))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defmethod</span><span class="fu"> lower </span><span class="at">::ir/inline-math</span> [_ math]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:p</span> (<span class="kw">str</span> <span class="st">&quot;$$&quot;</span> math <span class="st">&quot;$$&quot;</span>)])</span></code></pre></div>
<p>Custom headings HTML comment content divider Syntax highlighting Anchor Links</p>

</body>
</html>
